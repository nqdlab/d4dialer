{% load static %}
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>d4Dialer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </head>
  <body>
    <div class="container mt-5">     
      <input type="hidden" id="csrf-token" value="{{ csrf_token }}"> 
      <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true"> 
        <div class="modal-dialog"> 
          <div class="modal-content"> 
            <form id="settingsForm" method="post" action="{% url 'dialer' %}">
              {% csrf_token %}
              <input type="hidden" name="action" id="actionSettingsForm" value="start" />
              <div class="modal-header"> 
                <h5 class="modal-title" id="settingsModalLabel">Settings</h5> 
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button> 
              </div> 
              <div class="modal-body">
                <div class="row mb-3">
                  <label for="platformSelect" class="col-sm-4 col-form-label">VoIP Platform</label>
                  <div class="col-sm-8">
                    <select class="form-select" id="platformSelect" name="voip_platform">
                      <option value="" selected disabled>-- Select VoIP Platform --</option>
                      <option value="asterisk" > Asterisk </option>
                      <option value="freepbx" > FreePBX </option>
                      <option value="freeswitch" > FreeSWITCH </option>
                      <option value="fusionpbx" > FusionPBX </option>
                    </select>
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="dbUserInput" class="col-sm-4 col-form-label">DB User</label>
                  <div class="col-sm-8">
                    <input type="text" id="dbUserInput" name="voip_platform_db_user" class="form-control" placeholder="username" />
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="dbPasswordInput" class="col-sm-4 col-form-label">DB Password</label>
                  <div class="col-sm-8">
                    <input type="text" id="dbPasswordInput" name="voip_platform_db_password" class="form-control" placeholder="password" />
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="dbHostInput" class="col-sm-4 col-form-label">DB Host</label>
                  <div class="col-sm-8">
                    <input type="text" id="dbHostInput" name="voip_platform_db_host" class="form-control" placeholder="host" />
                  </div>
                </div>
                <div class="row mb-3">
                  <label for="dbPortInput" class="col-sm-4 col-form-label">DB Port</label>
                  <div class="col-sm-8">
                    <input type="text" id="dbPortInput" name="voip_platform_db_port" class="form-control" placeholder="port" />
                  </div>
                </div>
                <div id="eslConfig" style="display:none;">
                  <div class="row mb-3">
                    <label for="eslIp" class="col-sm-4 col-form-label">ESL IP</label>
                    <div class="col-sm-8">
                      <input type="text" id="eslIp" name="voip_platform_api_host" class="form-control" placeholder="IP" />
                    </div>
                  </div>
                  <div class="row mb-3">
                    <label for="eslPort" class="col-sm-4 col-form-label">ESL Port</label>
                    <div class="col-sm-8">
                      <input type="text" id="eslPort" name="voip_platform_api_port" class="form-control" placeholder="Port" />
                    </div>
                  </div>
                  <div class="row mb-3">
                    <label for="eslSecret" class="col-sm-4 col-form-label">ESL Secret</label>
                    <div class="col-sm-8">
                      <input type="text" id="eslSecret" name="voip_platform_api_password" class="form-control" placeholder="Secret" />
                    </div>
                  </div>
                </div>
              </div>              
              <div class="modal-footer"> 
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> 
                <button type="submit" class="btn btn-primary">Save</button> 
              </div>                              
            </form>
          </div> 
        </div> 
      </div>

      <div class="d-flex align-items-center justify-content-between mb-3"> 
        <h1 class="fw-bold mb-0" id="d4dialerTitle" style="cursor:pointer;">d4Dialer</h1> 
        <button id="settingsButton" class="btn btn-secondary"> <i class="bi bi-gear"></i> </button> 
      </div>

      {% if db_connection and api_connection %}
        <div class="row mb-3 align-items-center">        
          <div class="col-md-6 d-flex justify-content-end">
            <form id="dialerForm" method="post" action="{% url 'dialer' %}" class="d-flex align-items-center m-0">
              {% csrf_token %}
              <input type="hidden" name="new_numbers" id="newNumbersInput" />
              <input type="hidden" name="deleted_numbers" id="deletedNumbersInput" />
              <input type="hidden" name="action" id="actionInput" value="save" />
              <input type="hidden" name="campaign_uuid" id="campaignUuidInput" />
              <input type="hidden" name="campaign_ivr_menu" id="campaignIvrMenuSelect" />
              <input type="hidden" name="campaign_sip_gateway" id="campaignSipGatewaySelect" />
              <input type="hidden" name="campaign_concurrent_calls" id="campaignConcurrentCallsInput" value="1" />
              <button type="hidden" id="saveButton" class="btn btn-success px-4 me-2" type="submit">Save</button>
            </form>
            <button type="hidden" id="deleteButton" class="btn btn-danger">Delete</button>
          </div>          
        </div>
        <div class="row border rounded shadow-sm">
          <div class="col-md-4 p-4 border-end d-flex flex-column align-items-start" style="justify-content: flex-start;">
            <h2 class="mb-3">Campaigns</h2>
            <ul class="list-group w-100 mb-3" id="campaignList">
              {% for campaign in campaigns %}
                <li class="list-group-item d-flex align-items-center campaign-item" data-campaign-id="{{ campaign.id }}">
                  <input type="checkbox" class="form-check-input me-2 campaign-checkbox" data-campaign-id="{{ campaign.id }}">
                  <span>{{ campaign.campaign_name }}</span>
                </li>
              {% empty %}
                <li class="list-group-item text-muted">No campaigns found.</li>
              {% endfor %}
            </ul>
          </div>      
          <div class="col-md-4 p-4 d-flex flex-column align-items-start">
            <h2 class="mb-3">Phone Numbers</h2>
            <div id="selectedCampaignUuid" class="mb-2 text-primary fw-bold" style="font-size: small;"></div>
            <div class="input-group mb-3">
              <input type="text" id="phoneInput" class="form-control" placeholder="Enter phone number" />
              <button id="addButton" class="btn btn-primary">Add</button>
            </div>            
            <ul id="phoneList" class="list-group w-100"></ul>          
          </div>
        </div>
        <div class="row border rounded shadow-sm mt-4" id="settingsSection">
          <div class="col-12 p-4">
            <h2 class="mb-3">Settings</h2>
            <div class="form-group row mt-3">
              <label for="sipGatewaySelect" class="col-sm-2 col-form-label">SIP Gateway</label>
              <div class="col-sm-10">
                <select class="form-control" id="sipGatewaySelect" name="sipGateway">
                  <option value="" selected disabled>-- Select SIP Gateway --</option>
                  {% for sip_gateway_name in sip_gateway_names %}
                    <option value="{{ sip_gateway_name }}">{{ sip_gateway_name }}</option>
                  {% endfor %}
                </select>
              </div>
              <label for="ivrSelect" class="col-sm-2 col-form-label">IVR</label>
              <div class="col-sm-10">
                <select class="form-control" id="ivrSelect" name="ivr">
                  <option value="" selected disabled>-- Select IVR Option --</option>
                  {% for ivr_menu in ivr_menu_names %}
                    <option value="{{ ivr_menu }}">{{ ivr_menu }}</option>
                  {% endfor %}
                </select>
              </div>
              <label for="concurrentCallsInput" class="col-sm-2 col-form-label">Concurrent calls</label>
              <div class="col-sm-10">              
                <input type="number" step="1" min="1" value="1" id="concurrentCallsInput" name="concurrentCalls" class="form-control" placeholder="Enter concurrent calls" />
              </div>
            </div>
          </div>
        </div>

        <div class="row border rounded shadow-sm mt-4" id="statusSection">
          <div class="col-12 p-4">
            <h2 class="mb-3">Status </h2>               
            <div class="row mb-3">
              <label for="campaignStatusP" class="col-sm-2 col-form-label">Campaign Status:</label>
              <div class="col-sm-10">
                <p id="campaignStatusP" class="form-control-plaintext"></p>
              </div>
            </div>
                      
            <form id="statusForm" method="post" action="{% url 'dialer' %}" class="d-flex align-items-center m-0">
              {% csrf_token %}       
              <input type="hidden" name="action" id="statusStart" value="start" />   
              <input type="hidden" name="campaign_uuid_start" id="campaignUuidInputStart"/>
              <button id="startButton" class="btn btn-success px-4 me-2" type="submit">Start</button>
            </form>         
          </div>
        </div>
      {% elif not db_connection %}
        <p>No DB Connection</p>
      {% elif not api_connection %}
        <p>No API Connection</p>
      {% else %}
        <p>Internal Error</p>
      {% endif %}   
    </div>

    <script>
      //db_connection can be True or False
      const dbConnection = {{ db_connection|yesno:"true,false" }};
      //api_connection can be 0 or 1
      const apiConnection = Boolean({{ api_connection }});
      const dialerUrl = "{% url 'dialer' %}";
      const voipPlatform = "{{voip_platform}}";
    </script> 
    <script src="{% static 'dialer.js' %}"></script>    
    <script>                                     
      document.querySelectorAll('.campaign-item').forEach(item => {
        item.addEventListener('click', function() {
          const campaignId = this.getAttribute('data-campaign-id');
          const selectedCampaignUuiDiv = document.getElementById('selectedCampaignUuid');
          selectedCampaignUuiDiv.textContent = '';
          newNumbers = [];
          deletedNumbers = [];
          
          //using Django template to iterate the campaigns object which is not JSON serializable          

          {% for campaign in campaigns %}
            if (campaignId == "{{ campaign.id }}") {
              selectedCampaignUuiDiv.textContent = "{{ campaign.campaign_uuid }}";
              selectedCampaignUuid = "{{ campaign.campaign_uuid }}";
              campaignUuidInput.value = "{{ campaign.campaign_uuid }}";
              campaignUuidInputStart.value = "{{ campaign.campaign_uuid }}";
              ivrSelect.value = "{{ campaign.campaign_ivr_menu }}";              
              campaignIvrMenuSelect.value = "{{ campaign.campaign_ivr_menu }}";
              sipGatewaySelect.value = "{{ campaign.campaign_sip_gateway }}";
              campaignSipGatewaySelect.value = "{{ campaign.campaign_sip_gateway }}";
              settingsSection.style.display = 'block';
              statusSection.style.display = 'block';
              saveButton.style.display = 'none';
              concurrentCallsInput.value = "{{ campaign.campaign_concurrent_calls }}";
              campaignConcurrentCallsInput.value = "{{ campaign.campaign_concurrent_calls }}";    
              
              const csrftoken = document.getElementById("csrf-token").value;
              const formData = new FormData(); 
              formData.append("action", "campaign_query"); 
              formData.append("campaign_uuid_query", selectedCampaignUuid);

              fetch(dialerUrl, {
                method: 'POST',
                headers: {
                  'X-CSRFToken': csrftoken 
                },
                body: formData
              })
                .then(response => {
                  if (!response.ok) {
                    throw new Error(response.status);
                  }
                  return response.json();
                })
                .then(data => {
                  const phoneList = document.getElementById("phoneList");
                  phoneList.innerHTML = "";
                  leadsInCampaign = [];

                  data.leads.forEach(lead => {                    
                    leadsInCampaign.push(lead);
                    appendPhoneToPhoneList(lead, phoneList);
                  });

                  campaignStatusP.innerText = data.campaign_status;
                  if (data.campaign_status == 'IN PROGRESS' ) {
                    startButton.disabled = true;
                  } else if (data.campaign_status == 'COMPLETED'){
                    startButton.disabled = true;
                  } else {
                    startButton.disabled = false;
                  }
                })
                .catch(error => {
                  console.error("Error fetching leads:", error);
                });
            }
          {% endfor %}
        });
      });            
    </script>  
  </body>
</html>