<!DOCTYPE html>
<html>
  <head>
    <h1 class="fw-bold" id="d4dialerTitle" style="cursor:pointer;">d4Dialer</h1>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  </head>
  <body>
    <div class="container mt-5">
      <div class="row mb-3 align-items-center">        
        <div class="col-md-6 d-flex justify-content-end">
          <form id="dialerForm" method="post" action="{% url 'dialer' %}" class="d-flex align-items-center m-0">
            {% csrf_token %}
            <input type="hidden" name="new_numbers" id="newNumbersInput" />
            <input type="hidden" name="deleted_numbers" id="deletedNumbersInput" />
            <input type="hidden" name="action" id="actionInput" value="save" />
            <input type="hidden" name="campaign_uuid" id="campaignUuidInput" />
            <input type="hidden" name="campaign_ivr_menu" id="campaignIvrMenuSelect" />
            <input type="hidden" name="campaign_sip_gateway" id="campaignSipGatewaySelect" />
            <input type="hidden" name="campaign_concurrent_calls" id="campaignConcurrentCallsInput" value="1" />
            <button id="saveButton" class="btn btn-success px-4 me-2" type="submit">Save</button>
          </form>
          <button id="deleteButton" class="btn btn-danger">Delete</button>
        </div>
      </div>
      <div class="row border rounded shadow-sm">
        <div class="col-md-4 p-4 border-end d-flex flex-column align-items-start" style="justify-content: flex-start;">
          <h2 class="mb-3">Campaigns</h2>
          <ul class="list-group w-100 mb-3" id="campaignList">
            {% for campaign in campaigns %}
              <li class="list-group-item d-flex align-items-center campaign-item" data-campaign-id="{{ campaign.id }}">
                <input type="checkbox" class="form-check-input me-2 campaign-checkbox" data-campaign-id="{{ campaign.id }}">
                <span>{{ campaign.campaign_name }}</span>
              </li>
            {% empty %}
              <li class="list-group-item text-muted">No campaigns found.</li>
            {% endfor %}
          </ul>
        </div>      
        <div class="col-md-4 p-4 d-flex flex-column align-items-start">
          <h2 class="mb-3">Phone Numbers</h2>
          <div id="selectedCampaignUuid" class="mb-2 text-primary fw-bold" style="font-size: small;"></div>
          <div class="input-group mb-3">
            <input type="text" id="phoneInput" class="form-control" placeholder="Enter phone number" />
            <button id="addButton" class="btn btn-primary">Add</button>
          </div>
          <input type="hidden" id="csrf-token" value="{{ csrf_token }}">
          <ul id="phoneList" class="list-group w-100"></ul>          
        </div>
      </div>
      <div class="row border rounded shadow-sm mt-4" id="settingsSection">
        <div class="col-12 p-4">
          <h2 class="mb-3">Settings</h2>
          <div class="form-group row mt-3">
            <label for="sipGatewaySelect" class="col-sm-2 col-form-label">SIP Gateway</label>
            <div class="col-sm-10">
              <select class="form-control" id="sipGatewaySelect" name="sipGateway">
                <option value="" selected disabled>-- Select SIP Gateway --</option>
                {% for sip_gateway_name in sip_gateway_names %}
                  <option value="{{ sip_gateway_name }}">{{ sip_gateway_name }}</option>
                {% endfor %}
              </select>
            </div>
            <label for="ivrSelect" class="col-sm-2 col-form-label">IVR</label>
            <div class="col-sm-10">
              <select class="form-control" id="ivrSelect" name="ivr">
                <option value="" selected disabled>-- Select IVR Option --</option>
                {% for ivr_menu in ivr_menu_names %}
                  <option value="{{ ivr_menu }}">{{ ivr_menu }}</option>
                {% endfor %}
              </select>
            </div>
            <label for="concurrentCallsInput" class="col-sm-2 col-form-label">Concurrent</label>
            <div class="col-sm-10">              
              <input type="number" step="1" min="1" value="1" id="concurrentCallsInput" name="concurrentCalls" class="form-control" placeholder="Enter concurrent calls" />
            </div>
          </div>
        </div>
      </div>

      <div class="row border rounded shadow-sm mt-4" id="statusSection">
        <div class="col-12 p-4">
          <h2 class="mb-3">Status</h2>           
          <form id="statusForm" method="post" action="{% url 'dialer' %}" class="d-flex align-items-center m-0">
            {% csrf_token %}       
            <input type="hidden" name="action" id="statusStart" value="start" />   
            <input type="hidden" name="campaign_uuid_start" id="campaignUuidInputStart"/>
            <button id="startButton" class="btn btn-success px-4 me-2" type="submit">Start</button>
          </form>         
        </div>
      </div>

    </div>
    <script>
      const phoneInput = document.getElementById('phoneInput');
      const addButton = document.getElementById('addButton');
      const phoneList = document.getElementById('phoneList');
      const newNumbersInput = document.getElementById('newNumbersInput');
      const deletedNumbersInput = document.getElementById('deletedNumbersInput');
      const campaignUuidInput = document.getElementById('campaignUuidInput');      
      const dialerForm = document.getElementById('dialerForm');
      const deleteButton = document.getElementById('deleteButton');
      const campaignCheckboxes = document.querySelectorAll('.campaign-checkbox');
      const saveButton = document.getElementById('saveButton');
      const ivrSelect = document.getElementById("ivrSelect");
      const sipGatewaySelect = document.getElementById("sipGatewaySelect");
      const settingsSection = document.getElementById("settingsSection");
      const statusSection = document.getElementById("statusSection");
      const campaignIvrMenuSelect = document.getElementById('campaignIvrMenuSelect');
      const campaignSipGatewaySelect = document.getElementById('campaignSipGatewaySelect');
      const campaignUuidInputStart = document.getElementById('campaignUuidInputStart');
      const concurrentCallsInput = document.getElementById('concurrentCallsInput');
      const PAGE_SIZE = 10;
      let currentPage = 1;
      let leadsInCampaign = [];
      let newNumbers = [];
      let selectedCampaignUuid = "";
      let deletedNumbers = [];
      
      saveButton.style.display = 'none';
      deleteButton.style.display = 'none';
      settingsSection.style.display = 'none';
      statusSection.style.display = 'none';
      

      document.getElementById('d4dialerTitle').addEventListener('click', function() {
        window.location.href = "{% url 'dialer' %}";
      });

      deleteButton.addEventListener('click', function() {
        // Get all checked checkboxes
        const checked = Array.from(document.querySelectorAll('.campaign-checkbox:checked'));
        if (checked.length === 0) {
          alert('Please select at least one campaign to delete.');
          return;
        }
        if (!confirm('Are you sure you want to delete the selected campaign(s)?')) {
          return;
        }

        // Collect campaign IDs to delete
        const campaignIds = checked.map(cb => cb.getAttribute('data-campaign-id'));

        // Create a form and submit it to Django for deletion
        const form = document.createElement('form');
        form.method = 'post';
        form.action = '{% url "dialer" %}';

        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrfToken;
        form.appendChild(csrfInput);

        // Add action
        const actionInput = document.createElement('input');
        actionInput.type = 'hidden';
        actionInput.name = 'action';
        actionInput.value = 'delete';
        form.appendChild(actionInput);

        // Add campaign IDs
        campaignIds.forEach(id => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'campaign_ids';
          input.value = id;
          form.appendChild(input);
        });

        document.body.appendChild(form);
        form.submit();
      });

      campaignCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const anyChecked = Array.from(campaignCheckboxes).some(cb => cb.checked);
          deleteButton.style.display = anyChecked ? 'inline-block' : 'none';
        });
      });

      addButton.addEventListener('click', function() {
        const value = phoneInput.value.trim();
        if (value) {
          newNumbers.push(value);
          let noDuplicateNewNumbers = [...new Set(newNumbers)];
          newNumbersInput.value = JSON.stringify(noDuplicateNewNumbers);
          phoneInput.value = '';
          phoneInput.focus();
          settingsSection.style.display = 'block';
          saveButton.style.display = 'block';

          const phoneList = document.getElementById("phoneList");
          phoneList.innerHTML = "";
          newNumbers.forEach(number => {
            appendPhoneToPhoneList({phone_number: number}, phoneList);
          });

          leadsInCampaign.forEach(lead => {
            appendPhoneToPhoneList(lead, phoneList);
          });

          deletedNumbers.forEach((number, index) => {
            if (number === value) {              
              deletedNumbers.splice(index, 1);
              deletedNumbersInput.value = JSON.stringify(deletedNumbers);
            }
          });
        }
      });          

      document.querySelectorAll('.campaign-item').forEach(item => {
        item.addEventListener('click', function() {
          const campaignId = this.getAttribute('data-campaign-id');
          const selectedCampaignUuiDiv = document.getElementById('selectedCampaignUuid');
          selectedCampaignUuiDiv.textContent = '';
          newNumbers = [];
          deletedNumbers = [];
          {% for campaign in campaigns %}
            if (campaignId == "{{ campaign.id }}") {
              selectedCampaignUuiDiv.textContent = "{{ campaign.campaign_uuid }}";
              selectedCampaignUuid = "{{ campaign.campaign_uuid }}";
              campaignUuidInput.value = "{{ campaign.campaign_uuid }}";
              campaignUuidInputStart.value = "{{ campaign.campaign_uuid }}";
              ivrSelect.value = "{{ campaign.campaign_ivr_menu }}";              
              campaignIvrMenuSelect.value = "{{ campaign.campaign_ivr_menu }}";
              sipGatewaySelect.value = "{{ campaign.campaign_sip_gateway }}";
              campaignSipGatewaySelect.value = "{{ campaign.campaign_sip_gateway }}";
              settingsSection.style.display = 'block';
              statusSection.style.display = 'block';
              saveButton.style.display = 'none';
              concurrentCallsInput.value = "{{ campaign.campaign_concurrent_calls }}";
              campaignConcurrentCallsInput.value = "{{ campaign.campaign_concurrent_calls }}";              
              
              const csrftoken = document.getElementById("csrf-token").value;
              const formData = new FormData(); 
              formData.append("action", "numbers_query"); 
              formData.append("campaign_uuid_query", selectedCampaignUuid);

              fetch("{% url 'dialer' %}", {
                method: 'POST',
                headers: {
                  'X-CSRFToken': csrftoken 
                },
                body: formData
              })
                .then(response => {
                  if (!response.ok) {
                    throw new Error(response.status);
                  }
                  return response.json();
                })
                .then(leads => {
                  const phoneList = document.getElementById("phoneList");
                  phoneList.innerHTML = "";
                  leadsInCampaign = [];
                  leads.forEach(lead => {                    
                    leadsInCampaign.push(lead);
                    appendPhoneToPhoneList(lead, phoneList);
                  });
                })
                .catch(error => {
                  console.error("Error fetching leads:", error);
                });
            }
          {% endfor %}
        });
      });      

      ivrSelect.addEventListener("change", function() {
        const selectedValue = ivrSelect.value;
        campaignIvrMenuSelect.value = selectedValue;
        saveButton.style.display = 'inline-block';
      });

      sipGatewaySelect.addEventListener("change", function() {
        const selectedValue = sipGatewaySelect.value;
        campaignSipGatewaySelect.value = selectedValue;
        saveButton.style.display = 'inline-block';
      });

      concurrentCallsInput.addEventListener("input", function() {
        const concurrentValue = concurrentCallsInput.value;
        campaignConcurrentCallsInput.value = concurrentValue;
        saveButton.style.display = 'inline-block';
      });

      appendPhoneToPhoneList = function(lead,list) {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between";

        const phoneSpan = document.createElement("span");
        phoneSpan.textContent = lead.phone_number;

        const statusSpan = document.createElement("span");
        statusSpan.textContent = lead.status || "N/A";

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn btn-sm btn-outline-danger";
        deleteBtn.innerHTML = '<i class="bi bi-trash"></i>';

        deleteBtn.addEventListener("click", () => { 
          deletedNumbers.push(lead.phone_number);
          deletedNumbersInput.value = JSON.stringify(deletedNumbers);   
          newNumbers.forEach((number, index) => {
            if (number === lead.phone_number) {
              newNumbers.splice(index, 1);
              newNumbersInput.value = JSON.stringify(newNumbers);
            }
          });       
          li.remove();
          saveButton.style.display = 'block';
        });

        li.appendChild(phoneSpan);
        li.appendChild(statusSpan);
        li.appendChild(deleteBtn);
        list.appendChild(li);
      };

    </script>
    <!-- Bootstrap JS (optional, for some components) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>